// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - synced with Clerk + Worker Profile
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  name      String?
  imageUrl  String?
  
  // Worker profile fields
  age              Int?
  gender           String?   // "male", "female", "other"
  yearsExperience  Int?      @default(0)
  jobTitle         String?
  department       String?
  
  // Relationships
  dailyForms       DailyForm[]
  teamMemberships  TeamMember[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Team - admin-created groups for scoped analytics
model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  members     TeamMember[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Many-to-many: users can be in multiple teams
model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

// Daily Safety Form submission
model DailyForm {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Form date and shift info
  date              DateTime  @db.Date
  shiftDuration     Float     // hours worked
  
  // Physical condition
  fatigueLevel      Int       // 1-10 scale
  
  // PPE compliance
  ppeItemsRequired  Int       @default(6)
  ppeItemsUsed      Int       @default(0)
  ppeComplianceRate Float     // 0.0 to 1.0
  ppeDetails        Json?     // array of PPE items used
  
  // Hazard exposure
  hazardExposures          Json      // { "noise": 2, "dust": 1, ... } hours per hazard
  totalHazardExposureHours Float     @default(0)
  
  // Symptoms
  symptoms          Json?     // array of symptoms
  
  // Incident reporting
  incidentReported     Boolean   @default(false)
  incidentDescription  String?
  
  // Risk score from ML model (0-100 scale)
  riskScore         Float     @default(0)
  
  // Additional notes
  notes             String?
  
  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}
